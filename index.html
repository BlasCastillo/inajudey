
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Estructura de Costos</title>
    <!-- Chosen Palette: Tailwind CSS Slate & Teal -->
    <!-- Application Structure Plan: A single-page, top-to-bottom dashboard design is used instead of tabs to create a fluid user experience. The user enters foundational costs (fixed, tools), then defines products and margins. All data feeds into a real-time financial dashboard at the bottom, featuring key metrics and charts. This structure guides the user logically through their business costs without fragmented navigation. The PDF generation now targets a hidden summary section to ensure a clean, single-page report. -->
    <!-- Visualization & Content Choices: Fixed/Variable Costs -> Goal: Compare Proportions -> Donut Chart (Chart.js) for an intuitive breakdown. Product Cost vs. Price -> Goal: Compare Values -> Bar Chart (Chart.js) to clearly see profitability per product. Key Metrics (Break-even, ROI) -> Goal: Inform -> Stat Cards (HTML/Tailwind) for quick, scannable insights. All interactions are handled by vanilla JS to update the DOM and charts in real-time. PDF generation now captures chart images for accurate reporting. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            margin-bottom: 2rem;
        }
        .input-field {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e1;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #2dd4bf;
            box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.3);
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #14b8a6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0d9488;
        }
        .btn-danger {
            background-color: #f43f5e;
            color: white;
        }
        .btn-danger:hover {
            background-color: #e11d48;
        }
        .stat-card {
            background-color: #f0fdfa;
            border-left: 4px solid #14b8a6;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            max-width: 400px;
            margin: auto;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        /* Styles for PDF content - hidden by default */
        #pdf-summary-content {
            display: none;
            padding: 20px;
            font-family: 'Inter', sans-serif;
            color: #1a202c;
            background-color: #ffffff;
            page-break-after: always; /* Ensure content breaks correctly */
        }
        #pdf-summary-content h1, #pdf-summary-content h2, #pdf-summary-content h3 {
            color: #2d3748;
            margin-bottom: 10px;
        }
        #pdf-summary-content p {
            margin-bottom: 5px;
        }
        #pdf-summary-content .pdf-chart-img {
            max-width: 100%;
            height: auto;
            margin-top: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
        }
        #pdf-summary-content .pdf-stat-card {
            border: 1px solid #e0f2fe;
            background-color: #f0fdfa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 0.5rem;
        }
        #pdf-summary-content .pdf-stat-card h3 {
            font-size: 1rem;
            margin-bottom: 5px;
        }
        #pdf-summary-content .pdf-stat-card p {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .collapsible-header {
            cursor: pointer;
            padding: 1rem;
            background-color: #e2e8f0;
            border-radius: 0.75rem;
            font-weight: 600;
            color: #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 1rem;
        }
        .collapsible-content.active {
            max-height: 500px; /* Adjust as needed for content */
            padding-bottom: 1rem;

        }
        /* Estilos para el contenedor de la modal, el fondo semi-transparente */
    #summary-modal {
        transition: opacity 0.3s ease-in-out;
    }

    /* Estilos para el contenido de la modal */
    .modal-content {
        /* Define el ancho y alto máximo como porcentaje del viewport (pantalla) */
        max-width: 90vw;   /* 90% del ancho del viewport */
        max-height: 90vh;  /* 90% del alto del viewport */
        
        /* Asegura que el contenido sea desplazable si excede el tamaño máximo */
        overflow-y: auto;
    }

    /* Opcional: Estilos para pantallas más grandes, ajusta según sea necesario */
    @media (min-width: 768px) {
        .modal-content {
            max-width: 80vw;
            max-height: 80vh;
        }
    }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header id="pdf-header" class="flex items-center justify-center p-4 bg-white border-b border-gray-200">
    <div class="flex items-center gap-4">
        <img id="logo-inajudey" src="inajudey.jpg" alt="Logo de Inajudey" class="h-24">
        <h1 class="text-center font-bold text-lg md:text-xl text-gray-800">
            Intituto Autónomo de la Juventud del Estado Yaracuy
        </h1>
        <img id="logo-secundario" src="logo2.jpg" alt="Logo de Yaracuy" class="h-24">
    </div>
</header>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-900">Dashboard Financiero Interactivo</h1>
            <p class="mt-4 text-lg text-slate-600">Introduce los datos de tu negocio para calcular costos, precios y métricas de rentabilidad en tiempo real.</p>
            <div class="mt-8">
                <label for="business-name-input" class="font-semibold text-slate-700 block mb-2">Nombre de tu Negocio:</label>
                <input type="text" id="business-name-input" placeholder="Ej. Mi Tienda de Artesanías" class="input-field max-w-md mx-auto text-center text-xl font-bold">
            </div>
        

        <main id="main-dashboard-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Columna de Entradas de Datos -->
            <div class="lg:col-span-2 space-y-8">

                <!-- Instrucciones de Uso -->
                <section class="card">
                    <div class="collapsible-header" id="instructions-header">
                        <span>Instrucciones de Uso</span>
                        <span id="instructions-icon">▼</span>
                    </div>
                    <div class="collapsible-content" id="instructions-content">
                        <p class="mb-2">¡Bienvenido a tu dashboard financiero! Sigue estos pasos para usarlo:</p>
                        <ol class="list-decimal list-inside text-slate-600 space-y-1">
                            <li>**Nombre del Negocio:** Ingresa el nombre de tu negocio en la parte superior.</li>
                            <li>**Gastos Fijos:** Añade todos tus gastos mensuales que no varían (alquiler, salarios administrativos, seguros, etc.).</li>
                            <li>**Herramientas y Depreciación:** Registra tus herramientas para calcular su desgaste mensual (depreciación), que se suma a tus gastos fijos.</li>
                            <li>**Costo y Precio por Producto:** Define cada producto, sus costos directos (materia prima, mano de obra, empaque) y el margen de ganancia deseado sobre el precio de venta.</li>
                            <li>**Inversión y Ventas Estimadas:** Ingresa tu inversión inicial total y las unidades que esperas vender mensualmente para ver proyecciones.</li>
                            <li>**Resultados en Tiempo Real:** Todos los cálculos (punto de equilibrio, utilidad, ROI) se actualizarán automáticamente en el panel de la derecha.</li>
                        </ol>
                    </div>
                </section>
                
                <!-- Gastos Fijos -->
                <section id="fixed-costs" class="card">
                    <h2 class="text-2xl font-bold mb-4">1. Gastos Fijos Mensuales</h2>
                    <p class="text-slate-600 mb-6">Aquí se registran todos los costos que no cambian con el volumen de producción, como alquileres o suscripciones.</p>
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-slate-500 text-sm">
                                <th class="py-2 pr-2 font-semibold">Concepto del Gasto</th>
                                <th class="py-2 pr-2 font-semibold">Valor Mensual (Bs.S)</th>
                                <th class="py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="fixed-costs-table">
                            <!-- Filas de gastos fijos se agregarán aquí -->
                        </tbody>
                    </table>
                    <button id="add-fixed-cost-btn" class="btn btn-primary mt-4">Añadir Gasto Fijo</button>
                </section>

                <!-- Herramientas y Depreciación -->
                <section id="tools-depreciation" class="card">
                    <h2 class="text-2xl font-bold mb-4">2. Herramientas y Depreciación</h2>
                    <p class="text-slate-600 mb-6">Calcula el costo mensual del "desgaste" de tus herramientas. Este valor se suma automáticamente a tus gastos fijos.</p>
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-slate-500 text-sm">
                                <th class="py-2 pr-2 font-semibold">Nombre Herramienta</th>
                                <th class="py-2 pr-2 font-semibold">Costo Adquisición (Bs.S)</th>
                                <th class="py-2 pr-2 font-semibold">Valor Residual (Bs.S)</th>
                                <th class="py-2 pr-2 font-semibold">Vida Útil (Meses)</th>
                                <th class="py-2"></th>
                            </tr>
                        </thead>
                         <tbody id="tools-table">
                            <!-- Filas de herramientas se agregarán aquí -->
                        </tbody>
                    </table>
                    <button id="add-tool-btn" class="btn btn-primary mt-4">Añadir Herramienta</button>
                </section>

                <!-- Productos -->
                <section id="products" class="card">
                    <h2 class="text-2xl font-bold mb-4">3. Costo y Precio por Producto</h2>
                    <p class="text-slate-600 mb-6">Define tus productos, sus costos variables directos y el margen de ganancia deseado para calcular el precio de venta.</p>
                    <div id="products-table" class="space-y-6">
                        <!-- Tarjetas de productos se agregarán aquí -->
                    </div>
                    <button id="add-product-btn" class="btn btn-primary mt-6">Añadir Producto</button>
                </section>
                
            </div>

            <!-- Columna de Resumen Financiero (Dashboard) -->
             
            <aside class="lg:col-span-1 space-y-8">
                <div class="sticky top-8">
                    <section id="summary" class="card">
                        <h2 class="text-2xl font-bold mb-6 text-center">Resumen Financiero</h2>
                        
                        <div class="space-y-4">
                            <div class="stat-card">
                                <h3 class="font-semibold text-slate-700">Total Gastos Fijos Mensuales</h3>
                                <p id="summary-fixed-costs" class="text-2xl font-bold text-teal-600">0,00 Bs.S</p>
                            </div>
                            <div class="stat-card">
                                <h3 class="font-semibold text-slate-700">Punto de Equilibrio (Unidades)</h3>
                                <p id="summary-be-units" class="text-2xl font-bold text-teal-600">0</p>
                            </div>
                            <div class="stat-card">
                                <h3 class="font-semibold text-slate-700">Punto de Equilibrio (Ingresos)</h3>
                                <p id="summary-be-value" class="text-2xl font-bold text-teal-600">0,00 Bs.S</p>
                            </div>
                        </div>

                        <hr class="my-6">
                        
                        <h3 class="text-xl font-bold mb-4">Proyección de Rentabilidad</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="investment-input" class="font-semibold text-slate-700 block mb-1">Inversión Inicial Total (Bs.S)</label>
                                <input type="number" id="investment-input" value="10000" class="input-field">
                            </div>
                            <div>
                                <label for="sales-units-input" class="font-semibold text-slate-700 block mb-1">Unidades Vendidas Estimadas (Mes)</label>
                                <input type="number" id="sales-units-input" value="100" class="input-field">
                            </div>
                             <div class="stat-card">
                                <h3 class="font-semibold text-slate-700">Utilidad Neta Estimada</h3>
                                <p id="summary-profit" class="text-2xl font-bold text-green-600">0,00 Bs.S</p>
                            </div>
                            <div class="stat-card">
                                <h3 class="font-semibold text-slate-700">Retorno de Inversión (ROI)</h3>
                                <p id="summary-roi" class="text-2xl font-bold text-green-600">0.00 %</p>
                            </div>
                            <div class="stat-card bg-yellow-50 border-yellow-400">
                                <h3 class="font-semibold text-slate-700">Unidades para 30% ROI</h3>
                                <p id="suggested-roi-units" class="text-2xl font-bold text-yellow-700">0</p>
                            </div>
                        </div>
                        
                        <hr class="my-6">

                        <div class="mt-6">
                             <h3 class="text-xl font-bold mb-4 text-center">Desglose de Costos</h3>
                             <div class="chart-container">
                                <canvas id="costs-chart"></canvas>
                             </div>
                        </div>
                        
                         <div class="mt-8">
                             <h3 class="text-xl font-bold mb-4 text-center">Costo vs. Precio (Top 3 Productos)</h3>
                             <div class="chart-container" style="max-width: 100%;">
                                <canvas id="products-chart"></canvas>
                             </div>
                        </div>

                    </section>
                </div>

                
            </aside>
            
        </main>
        <div class="mt-8 text-center">
                    <button id="open-summary-modal-btn" class="btn btn-primary w-full md:w-auto">Ver Resumen Detallado</button>
                </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Variables y elementos del DOM ---
        const businessNameInput = document.getElementById('business-name-input');
        const fixedCostsTable = document.getElementById('fixed-costs-table');
        const addFixedCostBtn = document.getElementById('add-fixed-cost-btn');
        const toolsTable = document.getElementById('tools-table');
        const addToolBtn = document.getElementById('add-tool-btn');
        const productsTable = document.getElementById('products-table');
        const addProductBtn = document.getElementById('add-product-btn');
        const investmentInput = document.getElementById('investment-input');
        const salesUnitsInput = document.getElementById('sales-units-input');

        const summaryFixedCostsEl = document.getElementById('summary-fixed-costs');
        const summaryBeUnitsEl = document.getElementById('summary-be-units');
        const summaryBeValueEl = document.getElementById('summary-be-value');
        const summaryProfitEl = document.getElementById('summary-profit');
        const summaryRoiEl = document.getElementById('summary-roi');
        const suggestedRoiUnitsEl = document.getElementById('suggested-roi-units');

        const instructionsHeader = document.getElementById('instructions-header');
        const instructionsContent = document.getElementById('instructions-content');
        const instructionsIcon = document.getElementById('instructions-icon');

        // Modal elements
        const openSummaryModalBtn = document.getElementById('open-summary-modal-btn');
        const summaryModal = document.getElementById('summary-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalProductCountEl = document.getElementById('modal-product-count');
        const modalTotalInvestmentEl = document.getElementById('modal-total-investment');
        const modalTotalFixedCostsEl = document.getElementById('modal-total-fixed-costs');
        const modalAverageMarginEl = document.getElementById('modal-average-margin');
        const modalBeUnitsEl = document.getElementById('modal-be-units');
        const modalBeValueEl = document.getElementById('modal-be-value');
        const modalProfitEl = document.getElementById('modal-profit');
        const modalRoiEl = document.getElementById('modal-roi');
        const modalProfitLabelEl = document.getElementById('modal-profit-label');
        const generatePdfBtn = document.getElementById('generate-pdf-btn');

        // Nuevos elementos para el PDF
        const logoInajudey = document.getElementById('logo-inajudey');
        const logoSecundario = document.getElementById('logo-secundario');
        
        let costsChart, productsChart;
        const currencySymbol = 'Bs.S';
        const defaultRoiTarget = 30;

        // --- Funciones de utilidad ---
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('es-VE', { style: 'currency', currency: 'VES' }).format(value).replace('VES', currencySymbol);
        };
        const formatPercentage = (value) => {
            return value.toFixed(2) + ' %';
        };

        // --- Lógica para añadir filas y cards dinámicamente ---
        const addRow = (table, fields) => {
            const row = document.createElement('tr');
            row.className = 'border-b border-slate-200 last:border-b-0';
            fields.forEach(field => {
                const cell = document.createElement('td');
                cell.className = 'py-2 pr-2';
                const input = document.createElement('input');
                input.type = field.type;
                input.placeholder = field.placeholder;
                input.className = `input-field ${field.class || ''}`;
                if (field.value) input.value = field.value;
                cell.appendChild(input);
                row.appendChild(cell);
            });
            const actionCell = document.createElement('td');
            actionCell.className = 'py-2';
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>';
            deleteBtn.className = 'btn btn-danger w-8 h-8 flex items-center justify-center';
            deleteBtn.onclick = () => {
                row.remove();
                calculateAll();
            };
            actionCell.appendChild(deleteBtn);
            row.appendChild(actionCell);
            table.appendChild(row);
            row.querySelectorAll('input').forEach(input => input.addEventListener('input', calculateAll));
        };
        
        const addProductCard = () => {
            const cardId = `product-${Date.now()}`;
            const card = document.createElement('div');
            card.id = cardId;
            card.className = 'card bg-slate-50';
            card.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <input type="text" id="${cardId}-name" placeholder="Nombre del Producto" class="input-field text-xl font-bold flex-grow product-name">
                    <button class="btn btn-danger btn-sm ml-4 product-delete-btn">Eliminar</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="${cardId}-raw" class="font-semibold text-slate-700 block mb-1">Costo Variable Directo (Bs.S)</label>
                        <input type="number" id="${cardId}-raw" placeholder="Ej. 100.00" class="input-field product-variable-cost" step="0.01">
                        <p class="text-sm text-slate-500 mt-1">Materia prima, mano de obra, empaque, etc.</p>
                    </div>
                    <div>
                        <label for="${cardId}-margin" class="font-semibold text-slate-700 block mb-1">Margen de Ganancia (%)</label>
                        <input type="number" id="${cardId}-margin" value="50" class="input-field product-margin" step="0.01">
                        <p class="text-sm text-slate-500 mt-1">Porcentaje deseado de ganancia sobre el precio de venta.</p>
                    </div>
                </div>
                <div class="mt-4 p-4 rounded-lg border border-teal-200 bg-teal-50">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-teal-700">Precio de Venta Calculado:</span>
                        <span class="text-xl font-extrabold text-teal-800 product-price">${formatCurrency(0)}</span>
                    </div>
                </div>
            `;
            productsTable.appendChild(card);
            card.querySelector('.product-delete-btn').onclick = () => {
                card.remove();
                calculateAll();
            };
            card.querySelectorAll('input').forEach(input => input.addEventListener('input', calculateAll));
        };

        // --- Lógica principal de cálculo ---
        const calculateAll = () => {
            // 1. Recolectar datos y calcular totales
            let totalFixedCosts = 0;
            fixedCostsTable.querySelectorAll('tr').forEach(row => {
                const value = parseFloat(row.querySelectorAll('input')[1].value) || 0;
                totalFixedCosts += value;
            });

            let totalDepreciation = 0;
            toolsTable.querySelectorAll('tr').forEach(row => {
                const cost = parseFloat(row.querySelectorAll('input')[1].value) || 0;
                const residual = parseFloat(row.querySelectorAll('input')[2].value) || 0;
                const months = parseFloat(row.querySelectorAll('input')[3].value) || 1;
                const depreciation = (cost - residual) / months;
                totalDepreciation += depreciation > 0 ? depreciation : 0;
            });
            
            const totalFixedAndDepreciation = totalFixedCosts + totalDepreciation;
            summaryFixedCostsEl.textContent = formatCurrency(totalFixedAndDepreciation);

            let totalVariableCost = 0;
            let totalSellPrice = 0;
            let totalMargin = 0;
            let productCount = 0;
            const productsData = [];

            productsTable.querySelectorAll('.card.bg-slate-50').forEach(card => {
                const variableCost = parseFloat(card.querySelector('.product-variable-cost').value) || 0;
                const margin = parseFloat(card.querySelector('.product-margin').value) / 100 || 0;
                
                const productSellPrice = margin < 1 ? variableCost / (1 - margin) : variableCost;
                
                card.querySelector('.product-price').textContent = formatCurrency(productSellPrice);

                totalVariableCost += variableCost;
                totalSellPrice += productSellPrice;
                totalMargin += parseFloat(card.querySelector('.product-margin').value) || 0;
                productCount++;
                
                productsData.push({
                    name: card.querySelector('.product-name').value || `Producto ${productCount}`,
                    cost: variableCost,
                    price: productSellPrice
                });
            });

            // 2. Calcular promedios para métricas globales
            const avgVariableCost = productCount > 0 ? totalVariableCost / productCount : 0;
            const avgSellPrice = productCount > 0 ? totalSellPrice / productCount : 0;
            const contributionMargin = avgSellPrice - avgVariableCost;

            // 3. Calcular métricas principales
            let beUnits = 0;
            if (contributionMargin > 0) {
                beUnits = totalFixedAndDepreciation / contributionMargin;
            }
            const beValue = beUnits * avgSellPrice;
            
            summaryBeUnitsEl.textContent = isFinite(beUnits) ? Math.ceil(Math.max(0, beUnits)) : 0;
            summaryBeValueEl.textContent = isFinite(beValue) ? formatCurrency(beValue) : formatCurrency(0);

            const investment = parseFloat(investmentInput.value) || 0;
            const salesUnits = parseFloat(salesUnitsInput.value) || 0;
            
            const totalRevenue = salesUnits * avgSellPrice;
            const totalVariableCostsForSales = salesUnits * avgVariableCost;
            const profit = totalRevenue - totalVariableCostsForSales - totalFixedAndDepreciation;
            
            summaryProfitEl.textContent = formatCurrency(profit);
            summaryProfitEl.className = `text-2xl font-bold ${profit >= 0 ? 'text-green-600' : 'text-red-600'}`;

            const roi = investment > 0 ? (profit / investment) * 100 : 0;
            summaryRoiEl.textContent = formatPercentage(roi);
            summaryRoiEl.className = `text-2xl font-bold ${roi >= 0 ? 'text-green-600' : 'text-red-600'}`;

            let suggestedUnitsForROI = 0;
            if (investment > 0 && contributionMargin > 0) {
                suggestedUnitsForROI = ((defaultRoiTarget / 100) * investment + totalFixedAndDepreciation) / contributionMargin;
            }
            suggestedRoiUnitsEl.textContent = isFinite(suggestedUnitsForROI) ? Math.ceil(Math.max(0, suggestedUnitsForROI)) : 'N/A';
            
            // 4. Actualizar gráficos y modal
            updateCostsChart(totalFixedAndDepreciation, totalVariableCostsForSales);
            updateProductsChart(productsData);
            updateModalSummary(productCount, totalFixedAndDepreciation, investment, totalMargin, beUnits, beValue, profit, roi);
        };
        
        // --- Funciones para actualizar gráficos y modal ---
        const updateCostsChart = (fixed, variable) => {
            const ctx = document.getElementById('costs-chart').getContext('2d');
            const data = {
                labels: ['Gastos Fijos', 'Gastos Variables'],
                datasets: [{
                    data: [fixed, variable],
                    backgroundColor: ['#2dd4bf', '#0f766e'],
                    hoverOffset: 4
                }]
            };
            if (costsChart) {
                costsChart.data = data;
                costsChart.update();
            } else {
                costsChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            }
        };

        const updateProductsChart = (productsData) => {
            const ctx = document.getElementById('products-chart').getContext('2d');
            const topProducts = productsData.slice(0, 3);
            const data = {
                labels: topProducts.map(p => p.name.length > 15 ? p.name.substring(0, 15) + '...' : p.name),
                datasets: [
                    { label: 'Costo Unitario', data: topProducts.map(p => p.cost), backgroundColor: '#14b8a6', borderRadius: 4 },
                    { label: 'Precio de Venta', data: topProducts.map(p => p.price), backgroundColor: '#0d9488', borderRadius: 4 }
                ]
            };
            if (productsChart) {
                productsChart.data = data;
                productsChart.update();
            } else {
                productsChart = new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
                });
            }
        };

        const updateModalSummary = (productCount, totalFixedCosts, investment, totalMargin, beUnits, beValue, profit, roi) => {
            const averageMargin = productCount > 0 ? totalMargin / productCount : 0;
            modalProductCountEl.textContent = productCount;
            modalTotalInvestmentEl.textContent = formatCurrency(investment);
            modalTotalFixedCostsEl.textContent = formatCurrency(totalFixedCosts);
            modalAverageMarginEl.textContent = formatPercentage(averageMargin);
            modalBeUnitsEl.textContent = isFinite(beUnits) ? Math.ceil(Math.max(0, beUnits)) : 0;
            modalBeValueEl.textContent = isFinite(beValue) ? formatCurrency(beValue) : formatCurrency(0);

            // Actualiza el texto de la etiqueta con las unidades de venta actuales
            modalProfitLabelEl.textContent = `Utilidad Neta Estimada (con ${salesUnitsInput.value || 0} unid.):`;

            modalProfitEl.textContent = formatCurrency(profit);
            modalProfitEl.className = `text-2xl font-bold mt-1 ${profit >= 0 ? 'text-green-700' : 'text-red-600'}`;
            modalRoiEl.textContent = formatPercentage(roi);
            modalRoiEl.className = `text-2xl font-bold mt-1 ${roi >= 0 ? 'text-green-700' : 'text-red-600'}`;
        }
        
        // Función para generar el PDF de forma programática
           
        function generateModalPDF() {
            // Variable para el código Base64 del logo de Inajudey
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let yOffset = 20; // Posición vertical inicial para el texto

            // 1. Añadir el encabezado al PDF
            // Añadir logo izquierdo
            if (logoInajudey) {
                const imgData = logoInajudey.src;
                doc.addImage(imgData, 'JPEG', 15, yOffset - 10, 20, 20);
            }
            // Añadir título
            doc.setFontSize(14);
            doc.text("Intituto Autónomo de la Juventud del Estado Yaracuy", 105, yOffset, null, null, "center");
            
            // Añadir logo derecho
            if (logoSecundario) {
                const imgData = logoSecundario.src;
                doc.addImage(imgData, 'JPEG', 180, yOffset - 10, 20, 20);
            }
            yOffset += 20; // Espacio después del encabezado
            doc.line(15, yOffset, 195, yOffset); // Línea divisoria
            yOffset += 10;

            // 2. Título del Resumen
            doc.setFontSize(22);
            doc.text("Resumen Financiero Detallado", 105, yOffset, null, null, "center");
            yOffset += 15;

            // 3. Sección de Resumen General
            doc.setFontSize(16);
            doc.text("Resumen General", 15, yOffset);
            yOffset += 10;
            doc.setFontSize(12);

            const productCount = document.getElementById('modal-product-count').textContent;
            const totalInvestment = document.getElementById('modal-total-investment').textContent;
            const totalFixedCosts = document.getElementById('modal-total-fixed-costs').textContent;
            const averageMargin = document.getElementById('modal-average-margin').textContent;
            const beUnits = document.getElementById('modal-be-units').textContent;
            const beValue = document.getElementById('modal-be-value').textContent;
            const profit = document.getElementById('modal-profit').textContent;
            const roi = document.getElementById('modal-roi').textContent;
            const profitLabel = modalProfitLabelEl.textContent;

            doc.text(`Total de Productos Definidos: ${productCount}`, 15, yOffset);
            yOffset += 7;
            doc.text(`Inversión Inicial Total: ${totalInvestment}`, 15, yOffset);
            yOffset += 7;
            doc.text(`Total Gastos Fijos Mensuales: ${totalFixedCosts}`, 15, yOffset);
            yOffset += 7;
            doc.text(`Margen Promedio de Productos: ${averageMargin}`, 15, yOffset);
            yOffset += 15;

            // 4. Sección Punto de Equilibrio
            doc.setFontSize(16);
            doc.text("Punto de Equilibrio", 15, yOffset);
            yOffset += 10;
            doc.setFontSize(12);
            doc.text(`En Unidades: ${beUnits}`, 15, yOffset);
            yOffset += 7;
            doc.text(`En Ingresos: ${beValue}`, 15, yOffset);
            yOffset += 15;
            
            // 5. Sección Proyección de Rentabilidad
            doc.setFontSize(16);
            doc.text("Proyección de Rentabilidad", 15, yOffset);
            yOffset += 10;
            doc.setFontSize(12);
            doc.text(`${profitLabel} ${profit}`, 15, yOffset);
            yOffset += 7;
            doc.text(`Retorno de Inversión (ROI): ${roi}`, 15, yOffset);
            yOffset += 15;

            // Guardar el PDF
            doc.save('resumen_financiero.pdf');
        }

        // --- Event Listeners ---
        addFixedCostBtn.addEventListener('click', () => addRow(fixedCostsTable, [
            { type: 'text', placeholder: 'Ej. Alquiler Local' },
            { type: 'number', placeholder: 'Ej. 500.00' }
        ]));
        
        addToolBtn.addEventListener('click', () => addRow(toolsTable, [
            { type: 'text', placeholder: 'Ej. Impresora 3D' },
            { type: 'number', placeholder: 'Ej. 800.00' },
            { type: 'number', placeholder: 'Ej. 100.00' },
            { type: 'number', placeholder: 'Ej. 48' }
        ]));
        
        addProductBtn.addEventListener('click', addProductCard);
        
        businessNameInput.addEventListener('input', calculateAll);
        investmentInput.addEventListener('input', calculateAll);
        salesUnitsInput.addEventListener('input', calculateAll);

        instructionsHeader.addEventListener('click', () => {
            instructionsContent.classList.toggle('active');
            instructionsIcon.textContent = instructionsContent.classList.contains('active') ? '▲' : '▼';
        });

        openSummaryModalBtn.addEventListener('click', () => {
            summaryModal.classList.remove('hidden');
            document.body.classList.add('modal-open');
        });
        closeModalBtn.addEventListener('click', () => {
            summaryModal.classList.add('hidden');
            document.body.classList.remove('modal-open');
        });
        summaryModal.addEventListener('click', (e) => {
            if (e.target === summaryModal) {
                summaryModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }
        });
        
        generatePdfBtn.addEventListener('click', generateModalPDF);


        // --- Inicialización ---
        addRow(fixedCostsTable, [{ type: 'text', placeholder: 'Ej. Alquiler Local', value: 'Alquiler Local' }, { type: 'number', placeholder: 'Ej. 500.00', value: '500' }]);
        addRow(toolsTable, [{ type: 'text', placeholder: 'Ej. Impresora 3D', value: 'Impresora' }, { type: 'number', placeholder: 'Ej. 800.00', value: '800' }, { type: 'number', placeholder: 'Ej. 100.00', value: '100' }, { type: 'number', placeholder: 'Ej. 48', value: '48' }]);
        addProductCard();
        calculateAll();
    });
</script>
    <div id="summary-modal" class="fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="modal-content bg-white rounded-2xl shadow-xl p-6 md:p-8 relative">
        <button id="close-modal-btn" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <h2 class="text-3xl font-bold text-slate-900 mb-6 text-center">Resumen Financiero Detallado</h2>

        <div class="space-y-6">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center p-4 bg-teal-50 rounded-xl border border-teal-200">
                <span class="text-lg font-semibold text-slate-700">Total de Productos Definidos:</span>
                <span id="modal-product-count" class="text-2xl font-bold text-teal-700">0</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                    <span class="text-sm font-semibold text-slate-500">Inversión Inicial Total:</span>
                    <p id="modal-total-investment" class="text-xl font-bold text-slate-800 mt-1">0,00 Bs.S</p>
                </div>
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                    <span class="text-sm font-semibold text-slate-500">Total Gastos Fijos Mensuales:</span>
                    <p id="modal-total-fixed-costs" class="text-xl font-bold text-slate-800 mt-1">0,00 Bs.S</p>
                </div>
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                    <span class="text-sm font-semibold text-slate-500">Margen Promedio de Productos:</span>
                    <p id="modal-average-margin" class="text-xl font-bold text-slate-800 mt-1">0.00 %</p>
                </div>
            </div>

            <div class="bg-blue-50 p-6 rounded-xl border border-blue-200">
                <h3 class="text-xl font-bold text-blue-800 mb-2">Punto de Equilibrio</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <span class="text-sm font-semibold text-slate-500">En Unidades:</span>
                        <p id="modal-be-units" class="text-2xl font-bold text-blue-700 mt-1">0</p>
                    </div>
                    <div>
                        <span class="text-sm font-semibold text-slate-500">En Ingresos:</span>
                        <p id="modal-be-value" class="text-2xl font-bold text-blue-700 mt-1">0,00 Bs.S</p>
                    </div>
                </div>
            </div>

            <div class="bg-green-50 p-6 rounded-xl border border-green-200">
                <h3 class="text-xl font-bold text-green-800 mb-2">Proyección de Rentabilidad</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <span id="modal-profit-label" class="text-sm font-semibold text-slate-500">Utilidad Neta Estimada:</span>
                        <p id="modal-profit" class="text-2xl font-bold text-green-700 mt-1">0,00 Bs.S</p>
                    </div>
                    <div>
                        <span class="text-sm font-semibold text-slate-500">Retorno de Inversión (ROI):</span>
                        <p id="modal-roi" class="text-2xl font-bold text-green-700 mt-1">0.00 %</p>
                    </div>
                </div>
            </div>
            <div class="text-center">
            <button id="generate-pdf-btn" class="btn btn-secondary">Generar PDF</button>
        </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>
